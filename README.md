# IPv6 prefix delegation in layer 3 mesh networks

## Problem 1

How do we distribute the IPv6 public prefix from a gateway to nodes in the
network? The problem is that we can't just use DHCPv6 or NDP because we
don't have one big layer-2-network.

## Problem 2

How do we guarantee that packets with a specific source address get routed
via the gateway the address originated from? The problem is that a gateway or
upstream ISP would possibly drop outbound packages that do not have a src ip
from the gateway prefix. This makes sense to mitigate e.g. DDoS attacks based
on source address spoofing.

## Problem

- public prefix owned by an internet gateway
- nodes in the network want to route data via the gateway
- nodes want/need to use a sub-prefix of the gateways prefix
- src address must be subprefix /128 of gateways public prefix
- avoid NAT if possible

## Ideas for solutions

- independent mechanism that configures prefixes in the network
- DHCPv6 over a layer 2 tunnel from the node to the gateway
- unicast request over DHCPv6 relay on the node to the gateway
- normal DHCPv6 prefix delegation from node to node
- NPTv6 Network Prefix Translation

### Assumption about the network

I assume that we can establish basic connectivity between nodes in the mesh
network by using ULA prefixes and a routing daemon that uses these addresses for
establishing a mesh network.

ULA: https://tools.ietf.org/html/rfc4193

### DHCPv6 over layer 2 tunnel

A layer 2 tunnel has an ethernet header in the inner header. Works on layer 2 of
the OSI model.

#### Prototype for DHCPv6 over layer 2 tunnel

For the validation of the idea I created a first prototype based on DHCPv6,
fastd as the layer 2 tunneling mechanism and OLSRv1 as routing daemon. I used
fastd as tunneling solution to automate the setup of the tunnel between the node
and the gateway. OLSRv1 establishs are route between the node and the gateway
using the ULA prefixes generated by OpenWRT.

This solution should work with every routing protocol that works with IPv6 and
sets a default route in one of the routing tables. Protocols such as OLSRv1,
OLSRv2, babel should work.

The node and the gateway both have a bridge configured:

```
config interface 'dhcp'
  option type 'bridge'
  option ip6assign '60'
  option bridge_empty '1'
  option ifname 'tap0'
```

The `tap0` interface created by the fastd daemon is part of the bridge. By
adding the `tap0` interface to both bridges we create a layer 2 network between
the node and the gateway.

The bridge on the node is configured as DHCPv6 client:

```
option proto 'dhcpv6'
```

The bridge on the gateway has a "public" (a prefix it would like to share)
prefix assigned:

```
option ip6prefix 'fd23::/48'
```

To actually share the prefix over the layer 2 tunnel created by fastd the
a DHCPv6 server is configured on the bridge of the gateway:

```
config dhcp 'dhcp'
	option interface 'dhcp'
	option dhcpv6 'server'
	option ra 'server'
```

On the gateway fastd is configured as server:

```
TODO
```

On the node fastd is configured as client:

```
TODO
```

As remote IP for the layer 2 tunnel I use the default route that was precomputed
by OLSRv1. We choose the closest gateway (OLSRv1 metric) and assume that the
gateway has (still) a prefix to share. The process of gateway selection is
automated by a small script that is run as cronjob every minute:

```
#!/bin/sh

gateway=$(ip -6 r | grep -m 1 default | cut -d' ' -f3)
echo "Gateway is ${gateway}"

uci delete fastd.sample_peer.remote
uci add_list "fastd.sample_peer.remote=[${gateway}]:1337"
uci commit

/etc/init.d/fastd reload
```

We search for the default gateway, change the remote address of the fastd
configuration and reload fastd. In case of a gateway change fastd shuts the
current connection down and reestablishes a connection to the new gateway.

### Unicast DHCPv6 request over DHCPv6 relay

### independent mechanism that configures prefixes in the network

DNCP: https://www.ietf.org/proceedings/93/slides/slides-93-homenet-6.pdf

Homenet prefix assignment algorithm:

https://tools.ietf.org/html/draft-pfister-homenet-prefix-assignment-01

## Terminology

- node
- gateway
- link
- site?
- network
- prefix
  - public
  - private
  - ULA

## Protocols

### Tunneling

- GRE6TAP
- L2TPv3
- IP-GUE
- fastd?

### Prefix delegation IPv6

- DHCPv6
- HNCP https://tools.ietf.org/html/rfc7788

### Routing

Source specific routing is a requirement for at least one of the proposed
solutions.

- babel
- OLSRv2
- (bmx)

## Random ideas

State about the prefix delegation is only of interest for the gateway that
shares the prefix and the node that uses the prefix.

A gateway should announce that a prefix is available for delegation.

Maybe a gateway should announce a prefix and the sub-prefixes it would like/can
share.

Announcement should contain the prefix and a list of (available sub-prefixes).

Use NAT of ULA prefixes as fallback solution, e.g. if we run out of prefixes.

Is it a requirement to distribute prefixes that are smaller than /64?

How does flooding of information work? Do they use "simple" flooding algorithms?
Who is a routing algorithm different from a flooding algorithm?

What a the fundamental building blocks of a modern routing protocol?

What is a router id good for?

How do you find the second best path to a destination in a distance vector
routing protocol?

"A prefix is said to be available if it does not overlap with any other
assignment by any other router in the network." Quote from:

https://tools.ietf.org/html/draft-pfister-homenet-prefix-assignment-01

The node that receives a prefix should advertice a route to this prefix. This
results in shorter routes in the network. No routes via the gateway to the node.
And we can see if a gateway still has prefixes available.

## Related mailing list conversations

- https://ml.ninux.org/pipermail/battlemesh/2016-February/004352.html
- https://ml.ninux.org/pipermail/battlemesh/2016-April/004700.html


## Final remarks

With a layer 2 routing protocol such as BATMAN prefix delegation is kind of
trivial.


